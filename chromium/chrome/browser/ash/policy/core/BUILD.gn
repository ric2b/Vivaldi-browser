# Copyright 2024 The Chromium Authors
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

import("//build/config/chromeos/ui_mode.gni")

assert(is_chromeos_ash)

static_library("core") {
  sources = [
    "browser_policy_connector_ash.cc",
    "browser_policy_connector_ash.h",
    "cached_policy_key_loader.cc",
    "cached_policy_key_loader.h",
    "device_attributes.h",
    "device_attributes_fake.cc",
    "device_attributes_fake.h",
    "device_attributes_impl.cc",
    "device_attributes_impl.h",
    "device_cloud_policy_client_factory_ash.cc",
    "device_cloud_policy_client_factory_ash.h",
    "device_cloud_policy_manager_ash.cc",
    "device_cloud_policy_manager_ash.h",
    "device_cloud_policy_store_ash.cc",
    "device_cloud_policy_store_ash.h",
    "device_cloud_policy_validator.cc",
    "device_cloud_policy_validator.h",
    "device_local_account.cc",
    "device_local_account.h",
    "device_local_account_extension_tracker.cc",
    "device_local_account_extension_tracker.h",
    "device_local_account_external_cache.cc",
    "device_local_account_external_cache.h",
    "device_local_account_policy_broker.cc",
    "device_local_account_policy_broker.h",
    "device_local_account_policy_provider.cc",
    "device_local_account_policy_provider.h",
    "device_local_account_policy_service.cc",
    "device_local_account_policy_service.h",
    "device_local_account_policy_store.cc",
    "device_local_account_policy_store.h",
    "device_policy_decoder.cc",
    "device_policy_decoder.h",
    "device_policy_remover.h",
    "dm_token_storage.cc",
    "dm_token_storage.h",
    "file_util.cc",
    "file_util.h",
    "policy_oauth2_token_fetcher.cc",
    "policy_oauth2_token_fetcher.h",
    "policy_pref_names.cc",
    "policy_pref_names.h",
    "reporting_user_tracker.cc",
    "reporting_user_tracker.h",
    "user_cloud_policy_manager_ash.cc",
    "user_cloud_policy_manager_ash.h",
    "user_cloud_policy_manager_factory_ash.cc",
    "user_cloud_policy_manager_factory_ash.h",
    "user_cloud_policy_store_ash.cc",
    "user_cloud_policy_store_ash.h",
    "user_cloud_policy_token_forwarder.cc",
    "user_cloud_policy_token_forwarder.h",
    "user_cloud_policy_token_forwarder_factory.cc",
    "user_cloud_policy_token_forwarder_factory.h",
  ]

  deps = [
    "//ash",
    "//ash/components/arc:arc_features",
    "//ash/constants",
    "//base",
    "//build:buildflag_header_h",
    "//build:chromeos_buildflags",
    "//chrome/browser:browser_process",
    "//chrome/browser/ash/policy/enrollment",
    "//chrome/browser/ash/policy/invalidation",
    "//chrome/browser/ash/policy/scheduled_task_handler",
    "//chrome/browser/ash/printing/enterprise",
    "//chrome/browser/ash/profiles",
    "//chrome/browser/ash/system",
    "//chrome/browser/profiles:profile",
    "//chrome/common",
    "//chrome/common:chrome_features",
    "//chrome/common:constants",
    "//chromeos/ash/components/cryptohome",
    "//chromeos/ash/components/dbus",
    "//chromeos/ash/components/dbus/session_manager",
    "//chromeos/ash/components/dbus/update_engine",
    "//chromeos/ash/components/dbus/upstart",
    "//chromeos/ash/components/dbus/userdataauth",
    "//chromeos/ash/components/dbus/userdataauth:userdataauth_proto",
    "//chromeos/ash/components/install_attributes",
    "//chromeos/ash/components/network",
    "//chromeos/ash/components/settings",
    "//chromeos/ash/components/system",
    "//chromeos/constants",
    "//chromeos/dbus/constants",
    "//chromeos/dbus/power",
    "//components/account_id",
    "//components/enterprise",
    "//components/invalidation/impl",
    "//components/keyed_service/content",
    "//components/keyed_service/core",
    "//components/ownership",
    "//components/policy:generated",
    "//components/policy/core/browser",
    "//components/policy/core/common",
    "//components/policy/core/common:common_constants",
    "//components/policy/core/common:policy_namespace",
    "//components/policy/proto:",
    "//components/prefs",
    "//components/session_manager/core",
    "//components/signin/public/base",
    "//components/signin/public/identity_manager",
    "//components/strings:components_strings",
    "//components/user_manager",
    "//components/variations",
    "//content/public/browser",
    "//extensions/browser",
    "//google_apis",
    "//net",
    "//services/network/public/cpp",
    "//third_party/re2:re2",
    "//ui/base",
    "//url",

    # TODO: Use //chrome/browser/ash/attestation instead after fixing cyclic dependency.
    "//chromeos/ash/components/dbus/attestation:attestation_proto",

    # TODO: Use //chrome/browser/ash/login/reporting instead after fixing cyclic dependency.
    "//chrome/browser/ash:lock_unlock_event_proto",
    "//chrome/browser/ash:login_logout_event_proto",
    "//chrome/browser/ash:os_events_proto",
    "//chromeos/ash/services/cros_healthd/public/mojom",
    "//components/webapps/browser",
  ]

  allow_circular_includes_from = [
    "//chrome/browser/ash/policy/enrollment",
    "//chrome/browser/ash/system",
  ]
}

static_library("test_support") {
  testonly = true

  sources = [
    "device_policy_builder.cc",
    "device_policy_builder.h",
    "device_policy_cros_browser_test.cc",
    "device_policy_cros_browser_test.h",
    "device_policy_cros_test_helper.cc",
    "device_policy_cros_test_helper.h",
    "fake_device_cloud_policy_manager.cc",
    "fake_device_cloud_policy_manager.h",
    "user_policy_test_helper.cc",
    "user_policy_test_helper.h",
  ]

  deps = [
    ":core",
    "//ash/constants",
    "//base",
    "//chrome/browser",
    "//chrome/browser:browser_process",
    "//chrome/browser/ash",
    "//chrome/browser/ash/policy/remote_commands/crd:test_support",
    "//chrome/browser/profiles:profile",
    "//chrome/common:constants",
    "//chrome/test:test_support_ui",
    "//chromeos/ash/components/dbus/session_manager",
    "//chromeos/ash/components/settings",
    "//chromeos/dbus/constants",
    "//components/policy:generated",
    "//components/policy/core/browser",
    "//components/policy/core/common",
    "//components/policy/core/common:common_constants",
    "//components/policy/core/common:test_support",
    "//components/policy/proto:",
    "//components/prefs",
    "//testing/gmock",
    "//testing/gtest",
    "//url",
  ]
}

source_set("unit_tests") {
  testonly = true

  sources = [
    "cached_policy_key_loader_unittest.cc",
    "device_cloud_policy_client_factory_ash_unittest.cc",
    "device_cloud_policy_manager_ash_unittest.cc",
    "device_cloud_policy_store_ash_unittest.cc",
    "device_local_account_external_cache_unittest.cc",
    "device_local_account_policy_service_unittest.cc",
    "device_local_account_unittest.cc",
    "device_policy_decoder_unittest.cc",
    "dm_token_storage_unittest.cc",
    "reporting_user_tracker_unittest.cc",
    "user_cloud_policy_manager_ash_unittest.cc",
    "user_cloud_policy_store_ash_unittest.cc",
    "user_cloud_policy_token_forwarder_unittest.cc",
  ]

  deps = [
    ":core",
    "//ash/constants",
    "//base",
    "//base/test:test_support",
    "//chrome/browser",
    "//chrome/browser/ash",
    "//chrome/browser/ash:test_support",
    "//chrome/browser/ash/ownership",
    "//chrome/browser/ash/policy/enrollment",
    "//chrome/browser/ash/policy/invalidation:test_support",
    "//chrome/browser/ash/policy/remote_commands/crd:test_support",
    "//chrome/browser/chromeos",
    "//chrome/browser/extensions",
    "//chrome/browser/policy:test_support",
    "//chrome/browser/ui",
    "//chrome/common:chrome_features",
    "//chrome/common:constants",
    "//chrome/common:non_code_constants",
    "//chrome/test:test_support",
    "//chromeos/ash/components/attestation:test_support",
    "//chromeos/ash/components/cryptohome",
    "//chromeos/ash/components/dbus",
    "//chromeos/ash/components/dbus/concierge",
    "//chromeos/ash/components/dbus/cryptohome",
    "//chromeos/ash/components/dbus/device_management",
    "//chromeos/ash/components/dbus/session_manager",
    "//chromeos/ash/components/dbus/userdataauth",
    "//chromeos/ash/components/install_attributes",
    "//chromeos/ash/components/install_attributes:test_support",
    "//chromeos/ash/components/policy",
    "//chromeos/ash/components/settings",
    "//chromeos/ash/components/system",
    "//chromeos/components/onc:test_support",
    "//chromeos/constants",
    "//chromeos/dbus/power",
    "//components/account_id",
    "//components/enterprise",
    "//components/policy:generated",
    "//components/policy/core/common",
    "//components/policy/core/common:common_constants",
    "//components/policy/core/common:test_support",
    "//components/policy/proto",
    "//components/prefs",
    "//components/prefs:test_support",
    "//components/session_manager/core",
    "//components/signin/public/identity_manager",
    "//components/signin/public/identity_manager:test_support",
    "//components/strings:components_strings",
    "//components/sync_preferences",
    "//components/user_manager",
    "//components/user_manager:common",
    "//components/user_manager:test_support",
    "//content/test:test_support",
    "//crypto",
    "//extensions/browser",
    "//extensions/browser/updater",
    "//extensions/browser/updater:test_support",
    "//extensions/common",
    "//extensions/common:mojom",
    "//google_apis",
    "//net",
    "//services/data_decoder/public/cpp:test_support",
    "//services/network:test_support",
    "//services/network/public/cpp",
    "//services/network/public/mojom:url_loader_base",
    "//testing/gmock",
    "//testing/gtest",
    "//ui/base",
    "//url",
  ]
}
